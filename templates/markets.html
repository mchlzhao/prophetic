{% extends "base.html" %}
{% block content %}

<h1>Welcome {{ user }}!</h1>

<a class="btn btn-outline-success mt-3" href="{% url 'market_create' %}">New Market</a>

<div id="markets_list">
    {% include "markets_list.html" %}
</div>

<script type="text/javascript">

(function doPoll(){
    $.get("{% url 'market_orders' %}", function(data) {
        console.log("polled");
        Object.keys(data).forEach(function(key) {
            var sellHTML = `<li class="list-group-item"><small class="fw-lighter">No sell orders</small></li>`;
            if (data[key]['sell_orders'].length > 0) {
                sellHTML = "";
                data[key]['sell_orders'].forEach(function(val) {
                    var button = "";
                    var className = "";
                    if (val['ordered_by'] == "{{ user.username }}") {
                        button = `<span class="btn badge bg-danger delete-button" id="${val['pk']}">Delete</span>`;
                        className = "order_price";
                    }
                    sellHTML +=
                    `<li class="list-group-item">
                        <div class="hoverable justify-content-between d-flex">
                            ${val['ordered_by']}
                            ${button}
                            <span class=${className}>
                                <small class="fw-light">sell at </small>${val['price']}
                            </span>
                        </div>
                    </li>`;
                })
            }
            document.getElementById("sell_orders_" + key).innerHTML = sellHTML;

            var buyHTML = `<li class="list-group-item"><small class="fw-lighter">No buy orders</small></li>`;
            if (data[key]['buy_orders'].length > 0) {
                buyHTML = "";
                data[key]['buy_orders'].forEach(function(val) {
                    var button = "";
                    var className = "";
                    if (val['ordered_by'] == "{{ user.username }}") {
                        button = `<span class="btn badge bg-danger delete-button" id="${val['pk']}">Delete</span>`;
                        className = "order_price";
                    }
                    buyHTML +=
                    `<li class="list-group-item">
                        <div class="hoverable justify-content-between d-flex">
                            ${val['ordered_by']}
                            ${button}
                            <span class=${className}>
                                <small class="fw-light">buy at </small>${val['price']}
                            </span>
                        </div>
                    </li>`;
                })
            }
            document.getElementById("buy_orders_" + key).innerHTML = buyHTML;
        });
        setTimeout(doPoll, 1000);
    });
})();

$(document).on("click", ".delete-button", function() {
    console.log("pressed");
    $.ajax({
        url: "{% url 'order_delete' %}",
        data: {
            "order_id": $(this).attr("id")
        },
        type: "get",
        success: function(data) {
            console.log(data);
        },
        failure: function(data) {
            console.log("failure");
            console.log(data);
        }
    })
});

</script>

{% endblock %}